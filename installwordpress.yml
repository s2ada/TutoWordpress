---

    - name: ping machine cible
      hosts: wordpress
      become: yes
      tasks:
        - name: ping_machine_cible
          ping:
#PHP
        - name: Add the ondrej PHP PPA
          apt_repository:
            repo: 'ppa:ondrej/php'
        - name: Install php
          package:
            name: "{{ item }}"
            state: present
          loop:
            - php
            - php-fpm
            - php-mysql
            - php-xml
        - name: Remove apache2
          package:
            name: apache2
            state: absent
#mysql
        - name: Install mysql
          package:
            name: "{{item}}"
            state: present
          loop:
            - mysql-server
            - python-mysqldb

        - name: Create mysqld.cnf
          template:
            src: templates/mysql/mysqld.cnf.j2
            dest: /etc/mysql/mysql.conf.d/mysqld.cnf
          notify: restart mysql

        - name: Generate new root password
          command: openssl rand -hex 7
          args:
            creates: /root/.my.cnf
          register: mysql_new_root_pass

        - name: Remove anonymous users
          mysql_user:
            name: ""
            state: absent
          when: mysql_new_root_pass.changed

        - name: remove test database
          mysql_db:
            name: test
            state: absent
          when: mysql_new_root_pass.changed

        - name: Output new root password
          debug:
            msg: "New root password is {{mysql_new_root_pass.stdout}}"
          when: mysql_new_root_pass.changed

        - name: Update root password
          mysql_user:
            name: root
            host: "{{ item }}"
            password: "{{mysql_new_root_pass.stdout}}"
          loop:
            - "{{ ansible_hostname }}"
            - 127.0.0.1
            - ::1
            - localhost
        - name: Create my.cnf
          template:
            src: templates/mysql/my.cnf.j2
            dest: /root/.my.cnf
#NginX
#Nginx
        - name: Install Nginx
          package:
            name: nginx
            state: present

        - name: Start Nginx
          service:
            name: nginx
            state: started
            enabled: yes

        - name: Create nginx config
          template:
            src: templates/nginx/default.j2
            dest: /etc/nginx/sites-available/default
          notify: restart nginx

      handlers:
        - name: restart nginx
          service:
            name: nginx
            state: restarted

      handlers:
        - name: restart mysql
          service:
            name: mysql
            state: restarted
